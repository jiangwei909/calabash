#include <stdio.h>
#include <string.h>
#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>

#include "calabash.h"
#include "unity/unity.h"

#include "test_utils.h"

void test_cb_ut_decode_ec_sign_str()
{
    char *raw_str = "30819A022100E8A40858423BF5EFF4F5D8E43D056FB8A6A261FE1CC5A3553755A4258AAE1EB1022100AFDC80753D7DBAC0962F907087816B43E25AB48A671DA157EEE9EDC362AB0D37042026990E41F18785CF0419B9B782262E5A17E4D0347F5CB7C2F58AF4084FEF70BF04308EBAF076717B4A67FDDF321475075FFEA6443E0D9C90A480597FE2C0B1C94E5086555639565042B6E2322FB9B7E6A523";
    char* expected_str = "E8A40858423BF5EFF4F5D8E43D056FB8A6A261FE1CC5A3553755A4258AAE1EB1AFDC80753D7DBAC0962F907087816B43E25AB48A671DA157EEE9EDC362AB0D3726990E41F18785CF0419B9B782262E5A17E4D0347F5CB7C2F58AF4084FEF70BF8EBAF076717B4A67FDDF321475075FFEA6443E0D9C90A480597FE2C0B1C94E5086555639565042B6E2322FB9B7E6A523";

    char *raw_str2 = "3045022100BB43CFF29D25CEFC01B0E1318725DC19FDD26C794B920CEEE8E16548055CD53402201925E8434F63DB7C489EDFB2B1B27ED160A4B94BEF1F626683C2B959D554CC56";
    char *expected_str2 = "BB43CFF29D25CEFC01B0E1318725DC19FDD26C794B920CEEE8E16548055CD5341925E8434F63DB7C489EDFB2B1B27ED160A4B94BEF1F626683C2B959D554CC56";

    char bin[256] = { 0x0 };
    char out_bin[256] = { 0x0 };
    char out_hex[256] = { 0x0 };

    int bin_len = cb_hex_to_bin(raw_str, strlen(raw_str), bin);

    int out_bin_len = cb_ut_decode_ec_sign_str(bin, bin_len, out_bin);

    cb_bin_to_hex(out_bin, out_bin_len, out_hex);

    TEST_ASSERT_EQUAL_STRING(expected_str, out_hex);

    bin_len = cb_hex_to_bin(raw_str2, strlen(raw_str2), bin);
    out_bin_len = cb_ut_decode_ec_sign_str(bin, bin_len, out_bin);

    cb_bin_to_hex(out_bin, out_bin_len, out_hex);

    TEST_ASSERT_EQUAL_STRING(expected_str2, out_hex);
}

void test_cb_ut_encode_ec_sign_str()
{
    char *expected_str = "3045022100BB43CFF29D25CEFC01B0E1318725DC19FDD26C794B920CEEE8E16548055CD53402201925E8434F63DB7C489EDFB2B1B27ED160A4B94BEF1F626683C2B959D554CC56";
    char *raw_str = "BB43CFF29D25CEFC01B0E1318725DC19FDD26C794B920CEEE8E16548055CD5341925E8434F63DB7C489EDFB2B1B27ED160A4B94BEF1F626683C2B959D554CC56";

    char bin[256] = { 0x0 };
    char out_bin[256] = { 0x0 };
    char out_hex[256] = { 0x0 };

    int bin_len = cb_hex_to_bin(raw_str, strlen(raw_str), bin);

    int out_bin_len = cb_ut_encode_ec_sign_str(bin, bin_len, out_bin);

    cb_bin_to_hex(out_bin, out_bin_len, out_hex);

    TEST_ASSERT_EQUAL_STRING(expected_str, out_hex);

}

void test_cb_ut_encode_ec_cipher_str()
{
    char *expected_str = "30819A022100E8A40858423BF5EFF4F5D8E43D056FB8A6A261FE1CC5A3553755A4258AAE1EB1022100AFDC80753D7DBAC0962F907087816B43E25AB48A671DA157EEE9EDC362AB0D37042026990E41F18785CF0419B9B782262E5A17E4D0347F5CB7C2F58AF4084FEF70BF04308EBAF076717B4A67FDDF321475075FFEA6443E0D9C90A480597FE2C0B1C94E5086555639565042B6E2322FB9B7E6A523";
    char *raw_str = "E8A40858423BF5EFF4F5D8E43D056FB8A6A261FE1CC5A3553755A4258AAE1EB1AFDC80753D7DBAC0962F907087816B43E25AB48A671DA157EEE9EDC362AB0D3726990E41F18785CF0419B9B782262E5A17E4D0347F5CB7C2F58AF4084FEF70BF8EBAF076717B4A67FDDF321475075FFEA6443E0D9C90A480597FE2C0B1C94E5086555639565042B6E2322FB9B7E6A523";

    char bin[256] = { 0x0 };
    char out_bin[256] = { 0x0 };
    char out_hex[256] = { 0x0 };

    int bin_len = cb_hex_to_bin(raw_str, strlen(raw_str), bin);

    int out_bin_len = cb_ut_encode_ec_cipher_str(bin, bin_len, out_bin);

    cb_bin_to_hex(out_bin, out_bin_len, out_hex);

    TEST_ASSERT_EQUAL_STRING(expected_str, out_hex);

}
