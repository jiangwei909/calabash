#include <stdio.h>
#include <string.h>
#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>

#include "calabash.h"
#include "unity/unity.h"

#include "test_publicbox.h"

void test_cb_publicbox_seal()
{
    
    char *pk = "0492F775BC22B55B8CCBD2B8BE78E9F64D6AA74283C3A5127F8A50DEE107456A7FE28E2A15C219408FE05147A8C968FD88D7A88179530F1D836392C00A4B484DCD";
    char *plain = "123456781234567812345678123456781234567812345678";
    // char *plain = "ABCDEF0112345678";
    char *plain2 = "123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678";

    unsigned char cipher[8192] = { 0x0 };
    int cipher_len = 256;
    
    char cipher_hex[8192] = { 0x0 };
    int cipher_hex_len;
    int ret = -1;

    char puk_bin[128] = { 0x0 };
    int puk_bin_len = 0;

    cb_hex_to_bin(pk, strlen(pk), puk_bin);
    
    ret = cb_publicbox_seal(puk_bin, plain, strlen(plain), cipher);

    //char cipher_hex[8192] = { 0x0 };
    cb_bin_to_hex(cipher, ret, cipher_hex);

    printf("cipher len=%d cipher=%s\n", ret, cipher_hex);

    TEST_ASSERT_EQUAL_INT(0x81, cipher[0]);
    TEST_ASSERT_EQUAL_INT(145, ret);


    ret = cb_publicbox_seal(puk_bin, plain2, strlen(plain2), cipher);
    cb_bin_to_hex(cipher, ret, cipher_hex);

    printf("cipher2 len=%d cipher=%s\n", ret, cipher_hex);
    TEST_ASSERT_EQUAL_INT(0x82, cipher[0]);
}

void test_cb_publicbox_seal_open()
{
    char* sk = "74F3D6BCC82D29819BC9D9445210B3C581373715E3D728A54580B675C3CD6620";
    char *cipher = "811319BC61602C5901A99454F9AAB152E78D5DCD5A014DC431C4432B5E2F68C09333C5C7BF8C6F324D118C3D0D018B4CB95E3390FC07336DC6C5B60BF2D37180E352BC9154604A3723183A19A43B62A804EA64198172BCD1F077A2A5AC717B524C0022BC9C535FD6A5A925D08FFEA2F520BFC5E8D716ACCF6A465AEC3AD8A0CA5EFD5EC52BEF77F45BD94C370270A47B3E";
    //char *cipher = "011E85A546887775FBC2A244B8573ECBA98A67034EA8D4D6A891DB20DEB285E2C9866CB5B06E29568842874B18FDA822F8F219680D2CEB1FE6190E35A4B83F995C1D2524580AD2B8CEE78D5D0811C1B64EF9F34FCFE1DC5CC9D4CB951996E72D9F56FD18E2B5D608582E17FAF9A1D3334A3F7A4CEFA11A141712E5D2DBC185D8823AB93B8C78FCEED4A544D389D8A10BBA";
    char *expected_plain = "123456781234567812345678123456781234567812345678";
    int plain_len = 0;
    
    char *cipher2 = "8214943D2D3FCF7F5A2057FC0AEEDD70854BE6FB709E71CADF47B4A2F7BC2D91CC17E0AD166ECB51A9E62C5BADAEF1C98F946C6E21219B48745FF6FE2A69D8280FADA03CAB95135FCA550F82DF5C14D6C772B17FA4B2129451753E99D0358E1338A739915FA75A3F197E0CE6EFF2FD0EF766D00F39D87A04FD45F4BBD4EA2143438F414668710D481DDF4D786054FDF38B086F2F5254BC605B4433EB655D8D4CACCC19D1DD6208CCF6B0064B4029009859A85BC1E2B5DB30856BE393FFFDB455B25254F34CFC82B9160F0DF857259EE17A693FBBF3F94E87FCE2341ED87998572A0759B2A44E105F5D1CF371BC5C787710A988788460A1A6B483DCFA190F83BC27CF0B00C91A6FC2EB8F52CC7ECF92B21957684D744F6C584543FDFDEE6D7E58D203D0E3C728241206297B0023980C6913FCCE66F6B6120EA9D434D1629D85ED50ADEB10B1A3F6BFD346E4044384E5F158EF0CEEEC9F08733EB874255050DB588700A29D9B29BCB4695CDB720B158753D2DE789D37B776773F83E2FE1F52E5C7A36E32A0024A43281F8383B5BB910854212C4D8EB6ADA6143F49084B9DF9E5E8376F8A2FFA24C3255B2D8F89010641A1BF";
    char *expected_plain2 = "123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678123456781234567812345678";

    char cipher_hex[8192] = { 0x0 };
    int cipher_hex_len;
    int ret = -1;

    char cipher_bin[8192] = { 0x0 };
    int cipher_bin_len;
    char plain[1024] = { 0x0 };
    char pvk_bin[128] = { 0x0 };
    int pvk_bin_len = 0;

    cb_hex_to_bin(sk, strlen(sk), pvk_bin);
    cipher_bin_len = cb_hex_to_bin(cipher, strlen(cipher), cipher_bin);
    
    plain_len = cb_publicbox_seal_open(pvk_bin, cipher_bin, cipher_bin_len, plain);
    
    TEST_ASSERT_EQUAL_INT(48, plain_len);
    TEST_ASSERT_EQUAL_STRING(expected_plain, plain);

    cipher_bin_len = cb_hex_to_bin(cipher2, strlen(cipher2), cipher_bin);
    
    plain_len = cb_publicbox_seal_open(pvk_bin, cipher_bin, cipher_bin_len, plain);
    
    TEST_ASSERT_EQUAL_INT(288, plain_len);
    TEST_ASSERT_EQUAL_STRING(expected_plain2, plain);
}